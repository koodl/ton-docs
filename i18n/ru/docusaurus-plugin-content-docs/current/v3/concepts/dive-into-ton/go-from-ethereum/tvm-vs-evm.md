# ТВМ против EVM

Ethereum Virtual Machine (EVM) и TON Virtual Machine (TVM) являются виртуальными машинами на основе стека, разработанными для выполнения смарт-кода контракта. Несмотря на то, что они имеют общие черты, между ними существуют заметные различия.

## Представление данных

### Виртуальная машина Ethereum (EVM)

1. Единицы основных данных

- EVM работает в первую очередь на 256-битных целых числах, отражающих его дизайн вокруг криптографических функций Ethereum (например, операции по хэшированию Keccak-256 и эллиптической кривой).
- Типы данных в основном ограничены целым числом, байтами и иногда массивами этих типов, но все они должны соответствовать правилам 256-битной обработки данных.

2. Хранилище состояния

- Состояние блокчейна Ethereum - это сопоставление 256-битных адресов с 256-битными значениями. Это отображение поддерживается в структуре данных, известной как Merkle Patricia Trie (MPT).
- MPT позволяет Ethereum эффективно доказать целостность и целостность состояния блокчейна путем криптографической проверки, Это жизненно важно для децентрализованной системы, такой как Ethereum.

3. Ограничения структуры данных

- Упрощение до 256-битных текстовых ограничений означает, что EVM не имеет своей целью непосредственную обработку сложных или пользовательских структур данных.
- Зачастую разработчикам необходимо внедрять дополнительную логику в рамках смарт-контрактов для моделирования более сложных структур данных, что может привести к увеличению затрат на газ и сложности.

### ТОН Виртуальная машина (ТВМ)

1. Архитектура на основе ячеек

- ТВМ использует для представления данных уникальную модель «мешок клеток». Каждая ячейка может содержать до 128 байт данных и может иметь до 4 ссылок на другие ячейки.
- Эта структура позволяет ТВМ изначально поддерживать произвольные алгебраические типы данных и более сложные конструкции, такие как деревья или режиссерные ациклические графики (DAGs) непосредственно в своей модели хранения.

2. Гибкость и эффективность

- Модель ячейки обеспечивает значительную гибкость, что позволяет ТВ работать с широким спектром данных более естественным и эффективным, чем EVM.
- Например, способность создавать связанные структуры через клеточные ссылки позволяет создавать динамические и потенциально бесконечные структуры данных, которые имеют решающее значение для определенных типов приложений, таких как децентрализованные социальные сети или сложные децентрализованные протоколы финансирования DeFi.

3. Обработка сложных данных

- Возможность управлять сложными типами данных, присущими архитектуре ВМ, уменьшает потребность в реализации смарт-контрактов, потенциально снижая стоимость исполнения и увеличивая скорость исполнения.
- Разработка ТВМ особенно выгодна для приложений, требующих сложного государственного управления или взаимосвязанных структур данных, создание надежного фундамента для разработчиков для создания сложных и масштабируемых децентрализованных приложений.

## Машина в стеке

### Виртуальная машина Ethereum (EVM)

- EVM работает в качестве традиционного стека, где для управления вычислениями используется последняя стек (LIFO).
- Он обрабатывает операции нажатием и всплывающим 256-битным целым числом, которые являются стандартным размером для всех элементов стека.

### ТОН Виртуальная машина (ТВМ)

- TVM также функционирует как машина на основе стека, но с ключевым отличием: он поддерживает как 257-битные целые числа, так и ссылки на клетки.
- Это позволяет TVM отправлять и всплывать эти два разных типа данных вкл/выкл из стека, обеспечивая повышенную гибкость при использовании прямых данных.

### Пример операций стека

Предположим, что в EVM мы хотим добавить два числа (2 и 2). Этот процесс будет включать прокрутку номеров в стек, а затем вызов инструкции "ADD". Результат (4) останется на вершине стека.

Мы можем сделать эту операцию так же в ТВ. Но рассмотрим другой пример с более сложными структурами данных, такими как хэшкарты и ссылки на ячейки. Предположим, у нас есть хэшпап, который хранит пары ключевой стоимости, где ключи являются целыми числами и значениями либо целыми числами, либо ссылками ячеек. Давайте скажем, что наша хэшкарта содержит следующие записи:

```js
{
    1: 10
    2: cell_a (содержащий 10)
}
```

Мы хотим добавить значения, ассоциированные с ключами 1 и 2, и сохранить результат с ключом 3. Давайте рассмотрим операции в стеках:

1. Нажмите клавишу 1 на стек: `stack` = (1)
2. Звоните `DICTGET` для ключа 1 (возвращает значение, связанное с ключом в верхней части стека): Возвращает значение 10. `stack` = (10)
3. Нажмите клавишу 2 на стек: `stack` = (10, 2)
4. Звоните в `DICTGET` для ключа 2: Retrieves reference to Cell_A. `stack` = (10, Cell_A)
5. Load value from Cell_A: Выполняется инструкция для загрузки значения из ссылки на ячейку. `stack` = (10, 10)
6. Вызовите инструкцию `ADD`: Когда выполняется инструкция `ADD`, TVM покажет верхние два элемента из стека, добавит их вместе, а результат обратно в стек. В этом случае верхние два элемента составляют 10 и 10. После дополнения, стек будет содержать результат: `stack` = (20)
7. Нажмите 3 на стек: `stack` = (20, 3)
8. Звоните `DICTSET`: Магазин 20 с ключом 3. Обновлена хэшкарта:

```js
{
    1: 10,
    2: cell_a,
    3: 20
}
```

делать то же самое в EVM, необходимо определить сопоставление, которое хранит пары ключевого значения и функцию, где мы работаем непосредственно с 256-битными целыми числами, хранящимися в сопоставлении.
Важно отметить, что EVM поддерживает сложные структуры данных, используя Solidity, но эти структуры построены на основе более простой модели данных EVM, которая существенно отличается от более выразительной модели данных ТВМ

## Арифметические операции

### Виртуальная машина Ethereum (EVM)

- Виртуальная машина Ethereum (EVM) обрабатывает арифметику с использованием 256-битных целых чисел, что означает такие операции, как добавление, вычитание, умножение и деление по своему размеру данных.

### ТОН Виртуальная машина (ТВМ)

- TON Virtual Machine (TVM) поддерживает более разнообразные арифметические операции, включая 64 бит, 128-бит и 256-битные целые числа, как неподписанные и подписанные, так и модульные операции. ТВМ еще более укрепляет свой арифметический потенциал благодаря таким операциям, как мультипликация и деление сдвига, которые особенно полезны для реализации арифметики с фиксированной точкой. Этот выбор позволяет разработчикам выбирать наиболее эффективные арифметические операции на основе специфических требований их умных контрактов, предлагает потенциальную оптимизацию на основе размера и типа данных.

## Проверка переполнения

### Виртуальная машина Ethereum (EVM)

- В EVM проверки переполнения не выполняются самой виртуальной машиной. С введением солидарности 0.8.0 в целях повышения безопасности были интегрированы вопросы автоматического переполнения и переполнения переполнения. Эти проверки помогают предотвратить общие уязвимости, связанные с арифметическими операциями, но требуют новых версий солидарности, так как предыдущие версии требуют ручного применения этих гарантий.

### ТОН Виртуальная машина (ТВМ)

- В отличие от этого, TVM автоматически осуществляет проверку переполнения всех арифметических операций, что встроено непосредственно в виртуальную машину. Такой дизайн-выбор упрощает разработку смарт-контрактов за счет естественного уменьшения риска ошибок и повышения общей надежности и безопасности кода.

## Криптография и хэш функции

### Виртуальная машина Ethereum (EVM)

- EVM поддерживает специфическую схему криптографии Ethereum, такую как эллиптическая кривая secp256k1 и хэш keccak256. Кроме того, EVM не имеет встроенной поддержки доказательств Merkle, которые являются криптографическими доказательствами, используемыми для проверки членства элемента в наборе.

### ТОН Виртуальная машина (ТВМ)

- TVM предлагает поддержку 256-битной Elliptic Curve Cryptography (ECC) для предопределенных кривых, например Curve25519. Он также поддерживает пары Weil на некоторых эллиптических кривых, которые полезны для быстрой реализации zk-SNARKs (доказательства нулевого знания). Также поддерживаются популярные хэш-функции, такие как sha256, предоставляя больше возможностей для криптографических операций. Кроме того, TVM может работать с доказательствами Merkle, обеспечивая дополнительные криптографические функции, которые могут быть полезны для некоторых вариантов использования, например, верификация включения транзакции в блок.

## На высоком уровне языки

### Виртуальная машина Ethereum (EVM)

- EVM использует Солидарность в качестве высокоуровневого языка, который является объектно-ориентированным языком, подобным JavaScript и С++. Кроме того, существуют другие языки для написания смарт-контрактов Ethereum, таких как Vyper, Yul, и т.д.

### ТОН Виртуальная машина (ТВМ)

- TVM использует FunC в качестве языка высокого уровня, предназначенного для написания смарт-контрактов TON. Это процедурный язык со статическими типами и поддержкой алгебраических типов данных. FunC компилирует в Fift, который в свою очередь компилирует с ТВМ байткодом.

## Заключение

Таким образом, хотя и EVM и TVM являются станками на основе стека, предназначенными для выполнения смарт-контрактов, TVM предлагает более гибкую систему, поддержка более широкого спектра типов данных и структур, встроенная проверка переполнения, расширенные криптографические функции.

Поддержка смарт-контрактов ТВМ и его уникальный подход к представлению данных делают его лучше подходящим для определенных вариантов использования и масштабируемых блокчейн сетей.
