# TON DHT Service

Осуществление:

- https://github.com/ton-blockchain/ton/tree/master/dht
- https://github.com/ton-blockchain/ton/tree/master/dht-server

## Общий обзор

Распределённый хэш таблица Kademlia (DHT) играет решающую роль в сетевой части проекта TON и используется для нахождения других узлов в сети.

Ключи TON DHT - это просто 256-битные целые числа. В большинстве случаев они рассчитываются как SHA256 TL-сериализованный объект.

Значения, присвоенные этим 256-битным ключам, по сути, являются произвольными байтовыми строками ограниченной длины. Толкование
таких байтовых строк определяется предизображением соответствующего ключа; он
обычно известен как узлом, который ищет ключ, так и узлом
, который сохраняет ключ.

В простейшем случае ключ представляет ADNL адрес некоторого узла и значение может быть его IP-адресом и портом.

Сопоставление ключевого значения TON DHT хранится на точках DHT.

## DHT nodes

Каждый DHT узел имеет 256-битный DHT адрес. В отличие от адреса ADNL, DHT адрес не должен изменяться слишком часто, иначе другие узлы не смогут найти ключи, которые они ищет.

Ожидается, что значение ключа `K` будет храниться на `S` Kademlia-ближайших узлах в `K`.

Расстояние от Kademlia = 256-битный ключ `XOR` 256-битный адрес DHT узла (он не имеет ничего общего с географическим расположением).

`S` — маленький параметр, например `S = 7`, что необходимо для повышения надежности
DHT (если бы мы сохранили ключ только на одном узле, ближайший к `K`,
значение этого ключа будет утеряно, если этот отдельный узел выходит из строки).

## Таблица маршрутизации Kademlia

Любой узел, участвующий в DHT, обычно поддерживает таблицу маршрутизации Kademlia.

Он состоит из 256 ведров, пронумерованных от 0 до 255. The `i`-th
bucket will contain information about some known nodes (a fixed number
of the “best” nodes and maybe some extra candidates) that lie at a Kademlia
distance from `2^i` to `2^(i+1) − 1` from the node’s address `a`.

Эта информация включает в себя их DHT адреса, IP адреса, UDP порты и
некоторая информация о доступности, например, время и задержку последнего ping.

Когда узел Kademlia узнает о любом другом узле Kademlia в результате
некоторых запросов, он помещает его в подходящий ведро из своего таблицы маршрутизации, первый
в качестве кандидата. Затем, если некоторые из "лучших" узлов в этом сегменте не выполняются (например,
не отвечать на запросы ping длительное время), они могут быть заменены некоторыми
из этих кандидатов. Таким образом остается заселенный маршрутизационный стол Kademlia.

## Пара ключевого значения

Пара ключевого значения может быть добавлена и обновлена в TON DHT.

"Правила обновления" могут отличаться. В некоторых случаях они просто
позволяют заменить старое значение новым значением, при условии, что новое значение
подписано владельцем/создателем (подпись должна храниться как часть значения, для
будет проверяться позже любыми другими узлами после того, как они получат значение этого ключа).
В других случаях старое значение как-то влияет на новое значение. Например, она
может содержать порядковый номер, и старое значение перезаписывается только в том случае, если размер нового номера последовательности
превышает (для предотвращения повторных атак).

TON DHT не только используется для хранения IP адресов узлов ADNL, но также используется для других целей - он может хранить список адресов узлов, которые хранят конкретный торрент хранения TON, список адресов узлов, включенных в подсеть оверлея, Адреса ADNL сервисов TON или ADNL аккаунтов TON Blockchain и так далее.

:::info
Подробнее о TON DHT читайте в статье [DHT](/v3/documentation/network/protocols/dht/dht-deep-dive) или в главе 3.2. из [Whitepaper](https://docs.ton.org/ton.pdf).
:::
