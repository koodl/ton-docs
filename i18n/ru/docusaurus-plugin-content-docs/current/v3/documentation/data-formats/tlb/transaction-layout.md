# Макет транзакции

:::info
Чтобы максимально понять эту страницу, настоятельно рекомендуется ознакомиться с [языком TL-B](/v3/documentation/data-formats/tlb/cell-boc).
:::

TON Blockchain работает с тремя ключевыми частями: аккаунтами, сообщениями и транзакциями. На этой странице описывается структура и расположение транзакций.

Транзакция - это операция, которая обрабатывает входящие и исходящие сообщения, относящиеся к конкретному счету, изменяя его состояние и потенциально генерируя комиссии для валидаторов.

## Транзакция

```tlb
transaction$0111 account_addr:bits256 lt:uint64
    prev_trans_hash:bits256 prev_trans_lt:uint64 now:uint32
    outmsg_cnt:uint15
    orig_status:AccountStatus end_status:AccountStatus
    ^[ in_msg:(Maybe ^(Message Any)) out_msgs:(HashmapE 15 ^(Message Any)) ]
    total_fees:CurrencyCollection state_update:^(HASH_UPDATE Account)

```

| Поле                       | Тип                                                                                 | Требуется | Описание                                                                                                                                                                                                                                         |
| -------------------------- | ----------------------------------------------------------------------------------- | --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `account_addr`             | bits256                                                                             | Да        | Хэш-часть адреса, на котором была произведена транзакция. [Подробнее о адресах](/v3/documentation/smart-contracts/addresses#address-of-smart-contract)                                                                           |
| `lt`                       | uint64                                                                              | Да        | Представляет собой _логическое время_. [Подробнее о логическом времени](/v3/documentation/smart-contracts/message-management/messages-and-transactions#what-is-a-logical-time)                                                   |
| `преобразовать_trans_hash` | bits256                                                                             | Да        | Хэш предыдущей транзакции на этом аккаунте.                                                                                                                                                                                      |
| `преобразовать_trans_lt`   | uint64                                                                              | Да        | `lt` предыдущей транзакции на этом аккаунте.                                                                                                                                                                                     |
| `now`                      | uint32                                                                              | Да        | Значение «now», установленное при выполнении этой транзакции. Это метка времени Unix в секундах.                                                                                                                 |
| `outmsg_cnt`               | uint15                                                                              | Да        | Количество исходящих сообщений, созданных при выполнении этой транзакции.                                                                                                                                                        |
| `orig_status`              | [AccountStatus](#accountstatus)                                                     | Да        | Статус этого счета до совершения операции.                                                                                                                                                                                       |
| `end_status`               | [AccountStatus](#accountstatus)                                                     | Да        | Статус этого счета после совершения транзакции.                                                                                                                                                                                  |
| `in_msg`                   | (Мастер любой)                                                   | Нет       | Входящее сообщение, вызвавшее выполнение транзакции. Сохранено в ссылке.                                                                                                                                         |
| `out_msgs`                 | Хэшмапп 15 ^(Message Any)                                        | Да        | Словарь, содержащий список исходящих сообщений, которые были созданы при выполнении этой транзакции.                                                                                                                             |
| `всего_феи`                | [CurrencyCollection](/v3/documentation/data-formats/tlb/msg-tlb#currencycollection) | Да        | Общая сумма комиссий, которая была собрана во время выполнения этой транзакции. Он состоит из значения _Toncoin_ и, возможно, некоторых [Extra-currencies](/v3/documentation/dapps/defi/coins#extra-currencies). |
| `state_update`             | [HASH_UPDATE](#hash_update) Account                            | Да        | Структура `HASH_UPDATE`. Сохранено в ссылке.                                                                                                                                                                     |
| `description`              | [TransactionDescr](#transactiondescr-типы)                                          | Да        | Подробное описание процесса выполнения транзакции. Сохранено в ссылке.                                                                                                                                           |

## AccountStatus

```tlb
acc_state_uninit$00 = Статус счета;
acc_state_frozen$01 = Статус счета;
acc_state_active$10 = Статус счета;
acc_state_nonexist$11 = Статус счета;
```

- `[00]`: Аккаунт не инициализирован
- `[01]`: Account is frozen
- `[10]`: Account is active
- `[11]`: Аккаунт не существует

## HASH_UPDATE

```tlb
update_hashes#72 {X:Type} old_hash:bits256 new_hash:bits256
    = HASH_UPDATE X;
```

| Поле       | Тип     | Описание                                                          |
| ---------- | ------- | ----------------------------------------------------------------- |
| `old_hash` | bits256 | Хэш состояния счета перед выполнением транзакции. |
| `new_hash` | bits256 | Хэш состояния счета после выполнения транзакции.  |

## Типы операций Descr

- [Ordinary](#обычный)
- [Storage](#storage)
- [Tick-tock](#tick-tock)
- [Разделить готов](#split-prepare)
- [Сплит установку](#split-install)
- [Подготовка к объединению](#merge-prepare)
- [Объединить установку](#merge-install)

## Обычный

Это самый распространенный вид транзакции и он отвечает большинству потребностей разработчиков. Транзакции этого типа имеют только одно входящее сообщение и могут создавать несколько исходящих сообщений.

```tlb
trans_ord$0000 credit_first:Bool
    storage_ph:(Maybe TrStoragePhase)
    credit_ph:(Maybe TrCreditPhase)
    compute_ph:TrComputePhase action:(Maybe ^TrActionPhase)
    aborted:Bool bounce:(Maybe TrBouncePhase)
    destroyed:Bool
    = TransactionDescr;
```

| Поле           | Тип            | Требуется | Описание                                                                                                                                                                                        |
| -------------- | -------------- | --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `credit_first` | Бул            | Да        | Флаг, который соотносится с флагом «отказов» входящего сообщения. `credit_first = !bounce`                                                                                      |
| `storage_ph`   | TrStorageФаза  | Нет       | Содержит информацию о этапе хранения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases)                                                        |
| `credit_ph`    | ТрафикФаза     | Нет       | Содержит информацию о стадии исполнения сделки. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases)                                                         |
| `compute_ph`   | TrComputePhase | Да        | Содержит информацию о компьютерной фазе выполнения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases)                                          |
| `действие`     | TrActionФаза   | Нет       | Содержит информацию о этапе выполнения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases). Сохранено в ссылке. |
| `прервал`      | Бул            | Да        | Указывает, было ли прервано исполнение транзакции.                                                                                                                              |
| `отказок`      | TrBounceФаза   | Нет       | Содержит информацию о фазе возврата транзакции. [Подробнее](/v3/documentation/smart-contracts/message-management/non-bounceable-messages)                                       |
| \`уничтожил'   | Бул            | Да        | Указывает, был ли счет уничтожен в ходе выполнения.                                                                                                                             |

## Хранилище

Транзакции этого типа могут быть вставлены валидаторами по своему усмотрению. Они не обрабатывают входящие сообщения и не запускают никаких кодов. Их единственным следствием является сбор накопительных платежей со счета, что влияет на его статистику хранения и баланс. Если баланс счета упадет ниже определенной суммы, аккаунт может быть заморожен, а его код и данные заменены комбинированными хэшами.

```tlb
trans_storage$0001 storage_ph:TrStoragePhase
    = Описание операции;
```

| Поле         | Тип           | Описание                                                                                                                                 |
| ------------ | ------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| `storage_ph` | TrStorageФаза | Содержит информацию о этапе хранения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases) |

## Тик-Ток

Транзакции `Tick` и `Tock` зарезервированы для специальных системных смарт-контрактов, которые необходимо автоматически запускать в каждом блоке. Транзакции `Tick` вызываются в начале каждого блока masterchain и транзакции `Tock` вызываются в конце.

```tlb
trans_tick_tock$001 is_tock:Bool storage_ph:TrStoragePhase
    compute_ph:TrComputePhase action:(Maybe ^TrActionPhase)
    прерван:Bool destroyed:Bool = TransactionDescr;
```

| Поле         | Тип            | Требуется | Описание                                                                                                                                                                                        |
| ------------ | -------------- | --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `is_tock`    | Бул            | Да        | Флаг, указывающий тип транзакции. Используется для разделения транзакций `Tick` и `Tock`                                                                                        |
| `storage_ph` | TrStorageФаза  | Да        | Содержит информацию о этапе хранения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases)                                                        |
| `compute_ph` | TrComputePhase | Да        | Содержит информацию о компьютерной фазе выполнения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases)                                          |
| `действие`   | TrActionФаза   | Нет       | Содержит информацию о этапе выполнения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases). Сохранено в ссылке. |
| `прервал`    | Бул            | Да        | Указывает, было ли прервано исполнение транзакции.                                                                                                                              |
| \`уничтожил' | Бул            | Да        | Указывает, был ли счет уничтожен в ходе выполнения.                                                                                                                             |

## Подготовить разделение

:::note
Этот тип транзакции в настоящее время не используется. Информация об этом процессе ограничена.
:::

Сплит транзакции инициируются по крупным смарт-контрактам, которые должны быть разделены под высокой нагрузкой. Контракт должен поддерживать этот тип транзакции и управлять сплит процессом, чтобы сбалансировать нагрузку.

Сплит готовые транзакции инициируются когда смарт-контракт должен быть разделен. Умный контракт должен генерировать состояние для нового экземпляра самого себя.

```tlb
trans_split_prepare$0100 split_info:SplitMergeInfo
    storage_ph:(Maybe TrStoragePhase)
    compute_ph:TrComputePhase action:(Maybe ^TrActionPhase)
    aborted:Bool destroyed:Bool
    = TransactionDescr;
```

| Поле         | Тип                   | Требуется | Описание                                                                                                                                                                                        |
| ------------ | --------------------- | --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `split_info` | Объединить информацию | Да        | Информация о раздельном процессе.                                                                                                                                               |
| `storage_ph` | TrStorageФаза         | Нет       | Содержит информацию о этапе хранения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases)                                                        |
| `compute_ph` | TrComputePhase        | Да        | Содержит информацию о компьютерной фазе выполнения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases)                                          |
| `действие`   | TrActionФаза          | Нет       | Содержит информацию о этапе выполнения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases). Сохранено в ссылке. |
| `прервал`    | Бул                   | Да        | Указывает, было ли прервано исполнение транзакции.                                                                                                                              |
| \`уничтожил' | Бул                   | Да        | Указывает, был ли счет уничтожен в ходе выполнения.                                                                                                                             |

## Сплит установки

:::note
Этот тип транзакции в настоящее время не используется. Информация об этом процессе ограничена.
:::

Операции сплит инсталляция используются для создания новых экземпляров больших смарт-контрактов. Состояние для нового смарт-контракта создается при помощи транзакции [Split Prepare](#split-prepare).

```tlb
trans_split_install$0101 split_info:SplitMergeInfo
    prepare_transaction:^Транзакция
    установлена:Bool = Descr;
```

| Поле                  | Тип                        | Описание                                                                                                                              |
| --------------------- | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| `split_info`          | Объединить информацию      | Информация о раздельном процессе.                                                                                     |
| `prepare_transaction` | [Transaction](#транзакция) | Информация о [подготовленной транзакции](#split-prepare) для операции разделения. Сохранено в ссылке. |
| `installed`           | Бул                        | Указывает, была ли установлена транзакция.                                                                            |

## Подготовка к слиянию

:::note
Этот тип транзакции в настоящее время не используется. Информация об этом процессе ограничена.
:::

Слияние транзакций инициируется по крупным смарт-контрактам, которые должны быть рекомбинированы после разделения из-за высокой нагрузки. Контракт должен поддерживать этот тип транзакции и управлять процессом слияния для баланса нагрузки.

Объединить транзакции подготовки начинается, когда необходимо объединить два смарт-контракта. Умный контракт должен генерировать послание для другого экземпляра самого, чтобы облегчить слияние.

```tlb
trans_merge_prepare$0110 split_info:SplitMergeInfo
    storage_ph:TrStoragePhase прерван:Bool
    = Описание транзакции;
```

| Поле         | Тип                   | Описание                                                                                                                                 |
| ------------ | --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| `split_info` | Объединить информацию | Информация о процессе слияния.                                                                                           |
| `storage_ph` | TrStorageФаза         | Содержит информацию о этапе хранения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases) |
| `прервал`    | Бул                   | Указывает, было ли прервано исполнение транзакции.                                                                       |

## Объединить установку

:::note
Этот тип транзакции в настоящее время не используется. Информация об этом процессе ограничена.
:::

Слияние транзакций используется для слияния экземпляров больших смарт-контрактов. Специальное сообщение, облегчающее слияние, генерируется транзакцией [Подготовка к слиянию](#merge-prepare).

```tlb
trans_merge_install$0111 split_info:SplitMergeInfo
    prepare_transaction:^Транзакция
    storage_ph:(Maybe TrStoragePhase)
    credit_ph:(Maybe TrCreditPhase)
    compute_ph:TrComputePhase action:(Maybe ^TrActionPhase)
    прервана:Bool destroyed:Bool
    = TransactionDescr;
```

| Поле                  | Тип                        | Требуется | Описание                                                                                                                                                                                        |
| --------------------- | -------------------------- | --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `split_info`          | Объединить информацию      | Да        | Информация о процессе слияния.                                                                                                                                                  |
| `prepare_transaction` | [Transaction](#транзакция) | Да        | Информация о [подготовленной транзакции](#merge-prepare) для операции слияния. Сохранено в ссылке.                                                              |
| `storage_ph`          | TrStorageФаза              | Нет       | Содержит информацию о этапе хранения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases)                                                        |
| `credit_ph`           | ТрафикФаза                 | Нет       | Содержит информацию о стадии исполнения сделки. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases)                                                         |
| `compute_ph`          | TrComputePhase             | Да        | Содержит информацию о компьютерной фазе выполнения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases)                                          |
| `действие`            | TrActionФаза               | Нет       | Содержит информацию о этапе выполнения транзакции. [Подробнее](/v3/documentation/tvm/tvm-overview#transactions-and-phases). Сохранено в ссылке. |
| `прервал`             | Бул                        | Да        | Указывает, было ли прервано исполнение транзакции.                                                                                                                              |
| \`уничтожил'          | Бул                        | Да        | Указывает, был ли счет уничтожен в ходе выполнения.                                                                                                                             |

## Смотреть также

- Оригинальное описание [Планета переводов](/tblkch.pdf#page=75\&zoom=100,148,290) из бумаги
