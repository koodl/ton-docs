import ThemedImage from '@theme/ThemedImage';

# Схемы сообщений TL-B

В этом разделе подробно описаны схемы TL-B для сообщений.

## Сообщение TL-B

### TL-B

Схема основного сообщения TL-В, объявленная как комбинация нескольких вложенных структур

```tlb
сообщение$_ {X:Type} info:CommonMsgInfo
init:(Maybe (либо StateInit ^StateInit))
body:(Либо X ^X) = Сообщение X;

сообщение$_ {X:Type} info:CommonMsgInfoRelaxed
init:(Maybe (Either StateInit ^StateInit))
body:(Either X ^X) = MessageRelaxed X;

_ (Мессаж любой) = Сообщения;
```

Здесь `Сообщение X` - это общая структура сообщений, `MessageRelaxed X` дополнительный тип с CommonMsgInfoRelaxed телом и `Message Any` - это союз того и другого.
Структура сообщений объединена с X:Type, что другими словами является ячейка.
В соответствии с TL-B мы можем объединить все данные в одну ячейку (если она будет соответствовать 1023 битам) или использовать ссылки, объявленные с caret `^`.

Сериализованный `Message X` в список действий методом FunC send_raw_message(), чем умный контракт выполняет это действие и отправку сообщения.

### Определение четкой сериализации

Для построения корректных бинарных данных в соответствии с структурой TL-B мы должны сделать сериализацию, которая определяется для каждого типа периодически. Это означает, что для сериализации Сообщения X нам нужно знать, как сериализовать
`StateInit`, `CommonMsgInfo` и так далее.

Каждая вложенная структура мы должны получить от другой схемы TL-B по ссылке регулярно, до тех пор, пока сериализация для верхней структуры будет явным - каждый бит, определенный логическим или битовым типом (биты, uint, varuint).

Структуры, которые в настоящее время не используются в обычной разработке, отмечены знаком «_» в столбце «Тип», например _Любимое обычно пропущено в сериализации.

### сообщение$_

Существует верхняя схема TL-B целых сообщений «Сообщение X»:

```tlb
сообщение$_ {X:Type} info:CommonMsgInfo
init:(Maybe (либо StateInit ^StateInit))
body:(Либо X ^X) = Сообщение X;
```

| Структура   | Тип                               | Требуется   | Описание                                                                                                                             |   |
| ----------- | --------------------------------- | ----------- | ------------------------------------------------------------------------------------------------------------------------------------ | - |
| сообщение$_ | Конструктор                       |             | Она определена в соответствии с конструкторской линейкой. Пустой тег `$_` означает, что мы не будем добавлять биты в начале          |   |
| инфо        | [CommonMsgInfo](#commonmsginfo)   | Требуется   | Подробные свойства сообщения определяют пункт назначения и его значение. Всегда помещается в корневую ячейку сообщения.              |   |
| init        | [StateInit](#stateinit-tl-b)      | Опционально | Общая структура, используемая в TON для инициирования новых контрактов. Запись возможна в ссылку ячейки или корневую ячейку.         |   |
| тело        | Х                                 | Требуется   | Отправить сообщение Payload. Запись возможна в ссылку ячейки или корневую ячейку.                                                    |   |

```tlb
ничего$0 {X:Type} = Может быть X;
just$1 {X:Type} значение:X = Может быть X;
left$0 {X:Type} {Y:Type} значение:X = Either X Y;
right$1 {X:Type} {Y:Type} значение:Y = Either X Y;
```

Напоминаем, как работают «Может быть» и «Either», мы можем сериализовать различные случаи:

- `[CommonMsgInfo][10][StateInit][0][X]` - `Message X` in the one cell

<br></br>
<ThemedImage
alt=""
sources={{
light: '/img/docs/data-formats/tl-b-docs-9.png?raw=true',
dark: '/img/docs/data-formats/tl-b-docs-9-dark.png?raw=true',
}}
/>
<br></br>

- `[CommonMsgInfo][11][^StateInit][1][^X]` - `Сообщение X` со ссылками

<br></br>
<ThemedImage
alt=""
sources={{
light: '/img/docs/data-formats/tl-b-docs-8.png?raw=true',
dark: '/img/docs/data-formats/tl-b-docs-8-dark.png?raw=true',
}}
/>
<br></br>

## CommonMsgInfo TL-B

### CommonMsgInfo

`CommonMsgInfo` — это список параметров, определяющих, как сообщение будет доставлено в TON blockchain.

```tlb
//внутреннее сообщение
int_msg_info$0 ihr_disabled:Bool bounce:Bool bounced:Bool
  src:MsgAddressInt dest:MsgAddressInt
  value:CurrencyCollection ihr_fee:Grams fwd_fee:Grams
  created_lt:uint64 created_at:uint32 = CommonMsgInfo;

//внешнее входящее сообщение
ext_in_msg_info$10 src:MsgAddressExt dest:MsgAddressInt
  import_fee:Grams = CommonMsgInfo;

//внешнее исходящее сообщение
ext_out_msg_info$11 src:MsgAddressInt dest:MsgAddressExt
  created_lt:uint64 created_at:uint32 = CommonMsgInfo;
```

### int_msg_info$0

«int_msg_info» — это случай внутреннего сообщения. Это означает, что они могут быть направлены между контрактами и только между контрактами.
Вариант использования - обычные перекрестные сообщения.

```tlb
nanograms$_ amount:(VarUInteger 16) = Grams;
//internal message
int_msg_info$0 ihr_disabled:Bool bounce:Bool bounced:Bool
  src:MsgAddressInt dest:MsgAddressInt
  value:CurrencyCollection ihr_fee:Grams fwd_fee:Grams
  created_lt:uint64 created_at:uint32 = CommonMsgInfo;
```

| Структура         | Тип                                        | Требуется | Описание                                                                                                                                    |
| ----------------- | ------------------------------------------ | --------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| int_msg_info$0    | Конструктор                                | Требуется | Тег $0 означает, что в сериализации CommonMsgInfo начатый с 0 бит описывает внутреннее сообщение.                                           |
| ihr_выкл          | Бул                                        | Требуется | Флаг маршрутизации Hyper cube.                                                                                                              |
| отскок            | Бул                                        | Требуется | Сообщение должно быть возвращено, если есть ошибки во время обработки. Если сообщение отправляется в плоский отскок = 1, то вызовет отскок. |
| отскок            | Бул                                        | Требуется | Флаг, который описывает, это сообщение само является результатом отказов.                                                                   |
| src               | [MsgAddressInt](#msgaddressint-tl-b)       | Требуется | Адрес смарт-отправителя сообщения.                                                                                                          |
| кузня             | [MsgAddressInt](#msgaddressint-tl-b)       | Требуется | Адрес смарт-контракта назначения сообщения.                                                                                                 |
| значение          | [CurrencyCollection](#currencycollection)  | Требуется | Структура, описывающая информацию о валюте, включая суммарные средства, переведенные в сообщение.                                           |
| ihr_fee           | [VarUInteger 16](#varuinteger-n)           | Требуется | Плата за доставку гипермаршрутизации                                                                                                        |
| fwd_сбор          | [VarUInteger 16](#varuinteger-n)           | Требуется | Комиссия за переадресацию сообщений, назначенных валидаторами                                                                               |
| создан_lt         | uint64                                     | Требуется | Время отправки сообщения, назначенного валидатором. Используется для выполнения действий в умном контракте.                                 |
| создан_в          | uint32                                     | Требуется | Unix время                                                                                                                                  |

### ext_in_msg_info$10

`ext_in_msg_info$10` — это случай внешнего входящего сообщения. Это означает, что этот тип сообщений, отправляемых из контрактов в не-цепное пространство.
Вариант использования - запрос на кошелек к контракту на кошелёк.

```tlb
nanograms$_ amount:(VarUInteger 16) = Grams;
//Внешнее входящее сообщение
ext_in_msg_info$10 src:MsgAddressExt dest:MsgAddressInt
  import_fee:Grams = CommonMsgInfo;
```

| Структура                   | Тип                                  | Требуется | Описание                                                                                                                |
| --------------------------- | ------------------------------------ | --------- | ----------------------------------------------------------------------------------------------------------------------- |
| ext_out_msg_info$10         | Конструктор                          | Требуется | Тег `$10` означает, что в сериализации CommonMsgInfo начался с битов `10` описывает внешнее входящее сообщение.         |
| ihr_выкл                    | Бул                                  | Требуется | Флаг маршрутизации гипер. (сейчас всегда правда)                                                                        |
| src                         | [MsgAddressExt](#msgaddressext-tl-b) | Требуется | Адрес внешнего отправителя сообщения.                                                                                   |
| кузня                       | [MsgAddressInt](#msgaddressint-tl-b) | Требуется | Адрес смарт-контракта назначения сообщения.                                                                             |
| комиссия за импорт          | [VarUInteger 16](#varuinteger-n)     | Требуется | Комиссия за исполнение и доставку сообщений.                                                                            |

### ext_out_msg_info$11

`ext_out_msg_info$11` — это случай внешних исходящих сообщений. Это означает, что они могут быть отправлены из контрактов на выездное пространство.
Вариант использования - журналы.

```tlb
//внутреннее сообщение
ext_out_msg_info$11 src:MsgAddressInt dest:MsgAddressExt
  created_lt:uint64 created_at:uint32 = CommonMsgInfo;
```

| Структура            | Тип                                   | Требуется | Описание                                                                                                                         |
| -------------------- | ------------------------------------- | --------- | -------------------------------------------------------------------------------------------------------------------------------- |
| ext_out_msg_info$11  | Конструктор                           | Требуется | Тег `$11` означает, что в сериализации CommonMsgInfo начался с бита `11` описывает внешнее исходящее сообщение.                  |
| src                  | [MsgAddressInt](#msgaddressint-tl-b)  | Требуется | Флаг маршрутизации гипер. v                                                                                                      |
| кузня                | [MsgAddressExt](#msgaddressext-tl-b)  | Требуется | Общая структура, используемая в TON для инициализации новых контрактов. Запись возможна в ссылку ячейки или корневую ячейку.     |
| создан_lt            | uint64                                | Требуется | Время отправки сообщения, назначенного валидатором. Используется для выполнения действий в умном контракте.                      |
| создан_в             | uint32                                | Требуется | Unix время                                                                                                                       |

## StateInit TL-B

StateInit служит для представления внутренних данных по контракту и использования при развертывании контрактов.

```tlb
_ split_depth:(Maybe (## 5)) special:(Maybe TickTock)
  код:(Maybe ^Cell) данные:(Maybe ^Cell)
  библиотека:(HashmapE 256 SimpleLib) = StateInit;
```

| Структура      | Тип                      | Требуется   | Описание                                                                                                                                                                 |
| -------------- | ------------------------ | ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| раздел_глубина | (## 5)                   | Опционально | Параметр для контрактов с высокой нагрузкой определяет поведение разделения на несколько случаев в различных шардах. В настоящее время StateInit используется без этого. |
| спец.          | TickTock\*               | Опционально | Используется для вызова смарт-контрактов в каждом новом блоке блокчейна. Доступно только в шедевре. Контракты постоянных пользователей используются без них.             |
| код            | Ген                      | Опционально | Сериализованный код контракта.                                                                                                                                           |
| данные         | Ген                      | Опционально | Начальные данные контракта.                                                                                                                                              |
| библиотека     | HashmapE 256 SimpleLib\* | Опционально | В настоящее время используется StateInit без libs                                                                                                                        |

[Общие подробные описания хэшкарт](/v3/documentation/data-formats/tlb/tl-b-types#hashmap)

## MsgAddressExt TL-B

```tlb
addr_none$00 = MsgAddressExt;
addr_extern$01 len:(## 9) external_address:(bits len)
= MsgAddressExt;
```

«MsgAddress» - это схема различных сериализаций адресов. В зависимости от того, какие сообщения от участников (вне цепи или смартконтрактов) отправляются, различные структуры, использующие.

### addr_none$00

`addr_none$00` - используется для определения нулевого адреса участника off-chain. Это означает, что мы можем отправить внешнее сообщение на контракт без уникального адреса отправителя.

```tlb
addr_none$00 = MsgAddressExt;
```

| Структура           | Тип                | Требуется | Описание                                                                                                                 |
| ------------------- | ------------------ | --------- | ------------------------------------------------------------------------------------------------------------------------ |
| addr_none$00        | Конструктор        | Требуется | Тег `$00` означает, что в сериализации MsgAddressExt стартовал с битами `00`. Это означает, что весь внешний адрес `00`. |

### addr_extern$01

```tlb
addr_extern$01 len:(## 9) external_address:(bits len)
= MsgAddressExt;
```

| Структура        | Тип         | Требуется | Описание                                                                                                                  |
| ---------------- | ----------- | --------- | ------------------------------------------------------------------------------------------------------------------------- |
| addr_extern$01   | Конструктор | Требуется | Тег `$01` означает, что в сериализации MsgAddressExt, начинающийся с битов `01`, описывает внешний адрес.                 |
| len              | ## 9        | Требуется | То же, что и uintN - означает неподписанный N-бит номер                                                                   |
| внешний адрес    | (bits len)  | Требуется | Адрес является bitstring из len равным предыдущему «len»                                                                  |

## MsgAddressInt TL-B

```tlb
addr_std$10 anycast:(Maybe Anycast)
workchain_id:int8 address:bits256 = MsgAddressInt;

addr_var$11 anycast:(Maybe Anycast) addr_len:(## 9)
workchain_id:int32 address:(bits addr_len) = MsgAddressInt;
```

### addr_std$10

```tlb
addr_std$10 anycast:(Maybe Anycast)
workchain_id:int8 address:bits256 = MsgAddressInt;
```

| Структура    | Тип            | Требуется   | Описание                                                                                                             |
| ------------ | -------------- | ----------- | -------------------------------------------------------------------------------------------------------------------- |
| addr_std$10  | Конструктор    | Требуется   | Тег `$10` означает, что в сериализации MsgAddressExt, начинающийся с битов `10`, описывает внешний адрес.            |
| любой        | Любильник\*    | Опционально | Дополнительные адреса не используются в обычных внутренних сообщениях                                                |
| рабочий_id   | int8           | Требуется   | Рабочие цепи, где смарт-контракт назначения адрес размещен. На данный момент всегда равно нулю.                      |
| адрес        | (bits256)      | Требуется   | Номер аккаунта Smart контракта                                                                                       |

### addr_var$11

```tlb
addr_var$11 anycast:(Maybe Anycast) addr_len:(## 9)
workchain_id:int32 address:(bits addr_len) = MsgAddressInt;
```

| Структура    | Тип              | Требуется    | Описание                                                                                                                           |
| ------------ | ---------------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------- |
| addr_var$11  | Конструктор      | Требуется    | Тег `$11` означает, что в сериализации MsgAddressInt начался с битов `11` описывает адрес внутреннего контракта.                   |
| любой        | Любильник\*      | Опционально  | Дополнительные адреса не используются в обычных внутренних сообщениях                                                              |
| addr_len     | ## 9             | Требуется    | То же, что и uintN - означает неподписанный N-бит номер                                                                            |
| рабочий_id   | в тройку32       | Требуется    | Рабочие цепи, где смарт-контракт назначения адрес размещен. На данный момент всегда равно нулю.                                    |
| адрес        | (bits256)        | Требуется    | Payload-адрес (может быть ID аккаунта)                                                                                             |

## Основные используемые типы

### Коллекция валют

```tlb
Нанограммы$_ сумма:(VarUInteger 16) = Грамоты;
валюты$_ граммы:Grams other:ExtraCurrencyCollection
= Валютная коллекция;
```

| Структура     | Тип                      | Требуется   | Описание                                                                                                                |
| ------------- | ------------------------ | ----------- | ----------------------------------------------------------------------------------------------------------------------- |
| валют$_       | Конструктор              | Требуется   | \`Пустой тег$_означает, что в сериализации CurrencyCollection мы не будем добавлять биты в начале                       |
| граммы        | (VarUInteger 16)         | Требуется   | Значение сообщения в нанотонах                                                                                          |
| другой        | Дополнительная коллекция | Опционально | ExtraCurrencyCollection — это дикт, предназначенный для дополнительных валют, которые обычно пустые                     |

- Тип сложного типа ExtraCurrencyCollection, который обычно пишется как пустой dict в сообщениях

### VarUInteger n

```tlb
var_uint$_ {n:#} len:(#< n) value:(uint (len * 8))
= VarUInteger n;
var_int$_ {n:#} len:(#< n) value:(int (len * 8))
= VarInteger n;
```

| Структура     | Тип               | Требуется   | Описание                                                                                                                     |
| ------------- | ----------------- | ----------- | ---------------------------------------------------------------------------------------------------------------------------- |
| раз_инт$_     | Конструктор       | Требуется   | Пустой тег \`var_uint$_означает, что в сериализации CurrencyCollection мы не будем добавлять биты в начале                   |
| len           | uintN             | Требуется   | бит len параметра для следующего значения                                                                                    |
| значение      | (uint (len \* 8)) | Опционально | значение uint для целого числа записано в (len \* 8) битах                                                                   |

## Пример сообщения

### Внутреннее сообщение в func

```func
  var msg = begin_cell()
    .store_uint(0, 1) ;; tag
    . tore_uint(1, 1) ;; ihr_disabled
    tore_uint(1, 1) ;; разрешить отказы
    .store_uint(0, 1) ;; не отскакивать себя
    . tore_slice(source)
    .store_slice(destination)
    ;; сериализовать CurrencyCollection (см. ниже)
    . tore_coins(amount)
    .store_dict(extra_currencies)
    . tore_coins(0) ;; ihr_fee
    .store_coins(fwd_value) ;; fwd_fee
    . tore_uint(cur_lt(), 64) ;; lt транзакции
    .store_uint(now(), 32) ;; unixtime транзакции
    . tore_uint(0, 1) ;; без флага init-field (Maybe)
    . tore_uint(0, 1) ;; установить флаг тела сообщения (Either)
    .store_slice(msg_body)
  .end_cell();
```

### Обычное func сообщение в короткой форме

Части сообщения, которые всегда перезаписаны валидаторами, могут быть пропущены (заполнить нулевыми битами). Отправитель сообщения здесь пропущен, сериализован как `addr_none$00`.

```func
  ячейка msg = begin_cell()
        . tore_uint(0x18, 6)
        .store_slice(addr)
        tore_coins(amount)
        . tore_uint(0, 1 + 4 + 4 + 64 + 32 + 1 + 1)
        . tore_slice(message_body)
.end_cell();
```
