# TL

TL (Type Language) - это язык описания структур данных.

Для структурирования полезных данных при общении, используются [TL схемы](https://github.com/ton-blockchain/ton/tree/master/tl/generate/scheme).

TL работает на 32-битных блоках. Соответственно, размер данных в TL должен быть кратен 4 байта.
Если размер объекта не кратен в 4, нам нужно добавить требуемое количество нулевых байт к множеству.

Цифры всегда кодируются в Малом Эндианском порядке.

Подробнее о TL можно найти в [документации Telegram](https://core.telegram.org/mtproto/TL)

## Кодирование массива байт

Для кодирования массива байт сначала нужно определить его размер.
Если размер меньше 254 байт, то используется кодировка с 1 байтом. Если больше,
тогда 0xFE записывается как первый байт, как индикатор большого массива, а после него следуют 3 байта.

Например, мы кодируем массив `[0xAA, 0xBB]`, его размер составляет 2. We use 1 byte
size and then write the data itself, we get `[0x02, 0xAA, 0xBB]`, done, but we see
that the final size is 3 and not a multiple of 4 bytes, then we need to add 1 byte of padding to make it 4. Result: `[0x02, 0xAA, 0xBB, 0x00]`.

Если нам нужно закодировать массив, размер которого будет равен 396,
Мы это делаем: 396 >= 254, поэтому мы используем 3 байта для кодировки размера и 1 байт индикатора,
получаем: `[0xFE, 0x8C, 0x01, 0x00, массив байтов]`, 396+4 = 400, что много, не нужно выравнивать.

## Неочевидные правила сериализации

Часто перед самой схемой пишется 4-байтный префикс - его ID. Идентификатор схемы представляет собой CRC32 с таблицей IEEE из текста схемы, а символы, такие как `; и скобки `()\` ранее удалены из текста. Сериализация схемы с префиксом ID называется **boxed**, это позволяет парсеру определить, какая схема будет прежде, если есть несколько параметров.

Как определить сериализовать как коробок или нет? Если наша схема является частью другой схемы, то мы должны посмотреть, как тип поля указан, если он явно указан, то мы сериализуем без префикса, если не явно, (существует много таких типов), то мы должны сериализовать как коробку. Например:

```tlb
pub.unenc данные:байты = PublicKey;
pub.ed25519 key:int256 = PublicKey;
pub.aes key:int256 = PublicKey;
pub.overlay name:bytes = PublicKey;
```

У нас есть такие типы, если `PublicKey` указан в схеме, например `adnl.node id:PublicKey addr_list:adnl. ddressList = adnl.Node`, то он явно не указан и нам нужно сериализовать с префиксом ID (boxed). И если он указан следующим образом: `adnl.node id:pub.ed25519 addr_list:adnl.addressList = adnl.Node`, то это будет явным и префикс не требуется.

## Справочная литература

_Здесь [ссылка на оригинальную статью](https://github.com/xssnick/ton-deep-doc/blob/master/TL.md) от [Oleg Baranov](https://github.com/xssnick)._
