# Пул знаменателей

Умный контракт под названием Пул Нумератора, дает возможность одному или нескольким номинаторам одолжить Тонкон в доле валидатора, и гарантирует, что валидатор может использовать это Toncoin только для проверки. Кроме того, умный контракт гарантирует распределение вознаграждения.

## Архитектура

![image](/img/nominator-pool/nominator-pool.png)

## Лимиты

Этот пул предназначен для большого количества монет.

В процессе разработки главным критерием была безопасность и простота кода.

Пул не поддерживает небольшие депозиты или большое количество номинаторов в одном пуле.

Целевая протестированная конфигурация составляет минимум 10 тысяч ТОН для номиналов и максимум 40 номинаторов в пуле.

Количество кандидатур не было протестировано и мы настоятельно рекомендуем установить более 40 до тех пор, пока не будут проведены такие испытания.

## Комиссионные

Поскольку бассейн расположен в шестеренке с высокими комиссиями, для управления бассейном потребуется **5 TON** за каждый раунд валидации.

Операционные расходы оплачиваются валидатором.

:::info
Обратите внимание, что на балансе пула всегда должно быть **10 ТО** - это минимальный баланс сетевого хранилища. 10 TON не может быть снят.
:::

## Распределение наград

Для каждого раунда проверки пул посылает пакет к смарт-контракту избирателя.

После завершения раунда проверки пул возвращает свои средства с избирателя.

Обычно полученная сумма больше чем отправленная сумма, разница в валидации награда.

Валидатор получает долю вознаграждения, согласно неизменяемому пулу параметра `validator_reward_share`.

```
validator_reward = (вознаграждение * validator_reward_share) / 10000;
nominators_reward = вознаграждение - validator_reward;
```

Знаменатели разделяют оставшуюся награду в зависимости от размера их ставок.

Например, если в бассейне со ставками 100 к и 300 к тону есть два номинала, тогда первая будет иметь 25% и вторую 75% от `nominators_reward`.

### Знаменательный пул

В случае больших штрафов за подтверждение, когда полученная сумма меньше, чем отправленная сумма, убыток списывается из средств валидатора.

Если средств валидатора недостаточно, то оставшиеся убытки будут вычтены из номиналов пропорционально ставкам.

Обратите внимание, что пул разработан таким образом, чтобы средства для валидатора всегда были достаточными для покрытия максимального штрафа.

## Ответственность валидатора

Пул может участвовать в валидации только в том случае, если средства валидатора превышают неизменяемый параметр пула `min_validator_stake`.

Кроме того, средства валидатора должны превышать максимально возможный штраф за неисправную проверку. Рекомендуемый штраф рассчитывается на основе конфигурации сети.

В противном случае пул не будет отправлять запросы на участие в раунде проверки.

## Сообщения знаменателя

Взаимодействовать с пулом номинаторов, номинаторы отправляют простые сообщения с текстовым комментарием (можно отправить из любого приложения кошелька) в пул смарт-контракта.

**Сообщения должны быть отправлены в возвращаемом режиме!**

В случае опечатки или недействительного сообщения, сообщение будет возвращено отправителю.

Если вы отправляете сообщение с ошибкой или неверное сообщение в невозвращаемом режиме, то вы потеряете монеты.

## Депозит знаменателя

Для того, чтобы номинатор внес депозит, ему необходимо отправить сообщение на умный контракт с Тонкоином и текстовым комментарием "d".

Номинатор может отправлять сообщение только из кошелька, расположенного в базовом (необработанный адрес `0:...`).

Количество Toncoins должно быть больше или равно `min_nominator_stake + 1 TON`.

1 TON при депозите вычитается в качестве комиссии за обработку депозитов.

Если в настоящее время пул не участвует в проверке (`state == 0`), депозит будет зачислен немедленно.

Если пул в настоящее время участвует в проверке (`state ! Тогда сумма будет добавлена в `pending_deposit_amount\` номинала, и будут зачислены после завершения текущего раунда утверждения.

Номинатор может впоследствии послать больше Тонкоинов для увеличения своего вклада.

Обратите внимание, что если nominator-pool уже достиг числа номинаторов, равного `max_nominators_count`, , то депозиты от новых номинаторов будут отклонены (они будут возвращены отправителю).

## Снятие знаменателя

Для того, чтобы кандидат снял, ему нужно отправить сообщение в умный контракт с текстовым комментарием "w" и некоторыми Toncoins за сетевой сбор (1 TON достаточно). Непотраченные тоны, прикрепленные к сообщению, будут возвращены, за исключением очень редких случаев.

Если на балансе номинатора достаточно Тонкоинов, то вывод будет произведен немедленно. Все средства будут находиться на балансе номинального пула, когда он завершит участие в раунде проверки, но еще не подал просьбы об участии в новом раунде.

Если на номинальном балансе Тонкоинов недостаточно Тонкоинов, то будет сделано «withdraw_request» для номинала, и Тонкоины будут сняты после окончания текущего раунда проверки.

Номинатор может снять только все свои средства. Частичное снятие не поддерживается.

## Вывод валидатора

Валидатор может отозвать из пула все Тонкоины, которые не принадлежат номинаторам.

## Участники должны хранить свои закрытые ключи

Если номинатор теряет доступ к кошельку, из которого он сделал депозит, Он не сможет вывести свои средства из пула.

Если валидатор теряет доступ к своему кошельку, то он не сможет отозвать свои средства (validator) из пула.

Потеря приватного ключа кошелька одного участника пула не влияет на других участников.

## Экстренный вывод

При нормальной работе валидатор должен периодически посылать операционные сообщения в пул назначенного пользователя, такие как `process withdraw requests`, `update current validator set`, `new_stake`, `recover_stake`.

Программа валидатора mytonctrl делает это автоматически.

В чрезвычайной ситуации, например, если валидатор пропущен и перестает выполнять свои обязанности, Эти оперативные сообщения могут быть отправлены кем-либо и тем самым кандидаты могут отозвать свои средства.

## Голосование за предложения конфигурации сети

В ТОН [голосование валидаторов](/v3/documentation/smart-contracts/contracts-specs/governance#proposalvoting-mechanism).

В случае пула номинантов, понятно, что все участники могут голосовать, и окончательный результат будет направлен от имени пула.

Таким образом, умный контракт кандидата имеет встроенную функциональность, в которой валидатор и кандидаты могут заявить о своем голосовании за конкретное предложение.

Основываясь на таком голосовании, валидатор посылает финальный голос в смарт-контракт через программу валидатора.

Если валидатор отправил финальный голос в конфигурацию сети смарт-контракт, и голосование не совпадает с мнением большинства в пуле, в этом случае номинаторы могут покинуть этот пул и переместиться в другой.

Поскольку все происходит через транзакции по цепочке, такое несоответствие будет храниться в блокчейне и видно всем.

## Голосование составителя

Каждое новое предложение о смене сетевой конфигурации изначально направляется каналам Фонда TON [@tonblockchain](https://t.me/tonblockchain) или [@tonstatus](https://t.me/tonstatus).

В этой должности, в дополнение к описанию предложения, хэш этого предложения будет указан в HEX, например `D855FFBCF813E50E10BEAB902D1177529CE79785CAE913EB96A72AE8EFBCBF47`.

Для того чтобы кандидат голосовал за внесенное предложение, он должен отправить сообщение в пул нотариуса смарт-контракта с текстовым комментарием `y<HASH>`.

Для того чтобы кандидат голосовал против предложения, он должен отправить сообщение в пул нотариуса смарт-контракта с текстовым комментарием `n<HASH>`.

Для оплаты сетевого сбора необходимо прикрепить определенное количество токенов (1 Тон. Будут возвращены непотраченные тоны, прикрепленные к сообщению.

Голоса хранятся в контракте пула в течение 30 дней.

Только валидатор и нынешние кандидаты, имеющие активную долю в пуле, могут голосовать.

## Get-method `get_pool_data`

Возврат:

1. Состояние - uint - текущее состояние фонда-кандидата. 0 - не участвует в проверке, 1 - отправил запрос `new_stake` для участия в раунде проверки, 2 - получил успешное подтверждение об участии в раунде валидации.
2. nominators_count - uint - текущее количество номинаторов в пуле.
3. stake_amount_sent - nanotons - с таким объемом ставки пул участвует в текущем раунде валидации.
4. validator_amount - nanotons - количество монет валидатора.
5. validator_address - неизменяемый - uint - адрес валидатора кошелька. Чтобы получить адрес `"-1:" + dec_to_hex(validator_address)`.
6. validator_reward_share - неизменяемый - uint - какая доля вознаграждения от проверки поступает в валидатор. `validator_reward = (награда * validator_reward_share) / 10000`.  Например, установите 4000 для получения 40%.
7. max_nominators_count - неизменяемый - uint - максимальное количество номинаторов в этом пуле.
8. min_validator_stake - неизменяемые - nanotons - минимальная ставка для проверки в этом пуле.
9. min_nominator_stake - неизменяемые - nanotons - минимальная ставка за нотариуса в этом пуле.
10. номинаторы - ячейка - сырой словарь с номинирователями.
11. withdraw_requests - Cell - необработанный словарь с запросами на вывод средств от назначающих.
12. stake_at - uint - ID раунда валидации, в котором мы участвуем. Предлагается начать следующий раунд проверки (`utime_since`).
13. saved_validator_set_hash - uint - техническая информация.
14. validator_set_changes_count - uint - техническая информация.
15. validator_set_change_time - техническая информация.
16. stake_held_for - uint - техническая информация.
17. config_proposal_votings - Ген - необработанный словарь с настройками голосований.

## Получение метода `list_nominators`

Возвращает список текущих номиналов пула.

Each entry contains:

1. address - uint - nominator wallet address. To get the address do `"0:" + dec_to_hex(address)`.
2. amount - nanotons - current active stake of the nominator.
3. pending_deposit_amount - nanotons - deposit amount that will be added to the nominator's active stake at the next round of validation.
4. withdraw_request - int - if `-1` then this nominator sent a request to withdraw all of his funds.

## Get-method `get_nominator_data`

It takes as an argument the address of the nominator and returns:

1. amount - nanotons - current active stake of the nominator.
2. pending_deposit_amount - nanotons - deposit amount that will be added to the nominator's active stake at the next round of validation.
3. withdraw_request - int - if `-1` then this nominator sent a request to withdraw all of his funds.

Throws an `86` error if there is no such nominator in the pool.

To get a nominator for example with an address `EQA0i8-CdGnF_DhUHHf92R1ONH6sIA9vLZ_WLcCIhfBBXwtG` you need to convert address to raw form `0:348bcf827469c5fc38541c77fdd91d4e347eac200f6f2d9fd62dc08885f0415f`, drop `0:` and invoke `get_nominator_data 0x348bcf827469c5fc38541c77fdd91d4e347eac200f6f2d9fd62dc08885f0415f`.

## Get-method `list_votes`

Returns list of votes.

Each entry contains:

1. proposal_hash - uint - hash of proposal. Use `dec_to_hex(proposal_hash)` to convert hash to HEX form.
2. votes_create_time - uint - the unixtime this vote was created.

## Get-method `list_voters`

It takes as an argument the hash of the proposal and returns list of voters:

Each entry contains:

1. address - voter's address. To get the nominator address do `"0:" + dec_to_hex(address)`, if `address = validator_address` do `"-1:" + dec_to_hex(address)`.
2. support - int - if `-1` then it is a "vote for", otherwise it is a "vote against".
3. vote_time - uint - unixtime when he voted.

Voting results are calculated off-chain.

## Integration into wallet applications

For deposits, withdrawals and votes, send simple messages to the pool with the desired text comments as described above.

When sending a deposit, you can store the amount that was sent in the local storage.

When sending a re-deposit, add it to this amount too.

To find out the current profit, call the get method `get_nominator_data(your_address)`. Прибыль будет (`amount + pending_deposit_amount - sent_amount_stored_in_local_storage`).

Чтобы получить информацию о пуле, позвоните `get_pool_data` и `list_nominators` get-methods.

## Смотреть также

- [Номинатор пул](https://github.com/ton-blockchain/nominator-pool)
- [Как использовать Nominator Pool](/v3/guidelines/smart-contracts/howto/nominator-pool)
