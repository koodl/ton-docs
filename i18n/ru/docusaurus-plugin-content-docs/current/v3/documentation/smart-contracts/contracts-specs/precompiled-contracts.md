# Прекомпилированные контракты

_Прекомпилированный умный контракт_ это контракт с реализацией C++ в узле.
Когда валидатор запускает транзакцию по такому смарт-контракту, он может выполнить эту реализацию вместо ТВ.
Это повышает производительность и позволяет снизить комиссионные за вычисление.

## Настройка

Список предварительно скомпилированных контрактов хранится в конфигурации мастер-чата:

```
precompiled_smc#b0 gas_usage:uint64 = PrecompiledSmc;
precompiled_contracts_config#c0 list:(HashmapE 256 PrecompiledSmc) = PrecompiledContractsConfig;
_ PrecompiledContractsConfig = ConfigParam 45;
```

`list:(HashmapE 256 PrecompiledSmc)` — это карта `(code_hash -> precomplied_smc)`.
Если хэш кода контракта найден на этой карте, то контракт считается _предварительным_.

## Выполнение контракта

Любая транзакция на _предварительно скомпилированном смарт-контракте_ (т.е. контракт с хэшем кода, найденным в `ConfigParam 45`), выполняется следующим образом:

1. Получите `gas_usage` из конфигурации masterchain.
2. Если баланса недостаточно для оплаты газа «gas_usage», то вычислительная фаза опускается по причине пропуска `cskip_no_gas`.
3. Код может выполняться двумя способами:
4. Если предварительно скомпилированное выполнение отключено или реализация C++ недоступна в текущей версии узла, то TVM работает как обычно. Газовый лимит для ТВМ установлен на лимит газа (1М газа).
5. Если предварительно скомпилированная реализация включена и доступна, то выполняется реализация C++.
6. Переопределение [вычислительных значений фазы](https://github.com/ton-blockchain/ton/blob/dd5540d69e25f08a1c63760d3afb033208d9c99b/crypto/block.tlb#L308): установите `gas_used` на `gas_usage`; установите `vm_steps`, `vm_init_state_hash`, `vm_final_state_hash` на нуль.
7. Расчетная плата основана на газетах `gas_usage`, а не на фактическом использовании ТВМ.

При выполнении предварительно скомпилированного контракта в TVM 17-й элемент «c7» имеет значение «gas_usage» и может быть получен инструкцией «GETPRECOMPILEDGAS». Для нескомпилированных контрактов эта стоимость является "нулевым".

Выполнение предварительных контрактов по умолчанию отключено. Запустите `validator-engine` с флагом `--enable-precompiled-smc`, чтобы включить его.

Обратите внимание, что оба способа выполнения предварительно скомпилированного контракта дают одну и ту же транзакцию.
Таким образом, валидаторы с реализацией C++ и без нее могут безопасно сосуществовать в сети.
Это позволяет добавлять новые записи в `ConfigParam 45` без требования всех валидаторов немедленно обновить программное обеспечение узла.

## Доступные реализации

Hic sunt dracones.

## Смотреть также

- [Управляющие договоры](/v3/documentation/smart-contracts/contracts-specs/governance)
