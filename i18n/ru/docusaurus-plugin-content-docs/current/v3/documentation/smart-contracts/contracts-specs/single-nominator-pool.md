Импортировать вкладки из '@theme/Tabs';
импортировать вкладки из '@theme/TabItem';

# Пул однозначного знаменателя

[Единый номенклатор](https://github.com/orbs-network/single-nominator) является простым смарт-контрактом TON брандмауэра, который позволяет проверять безопасные блокчейны TON через холодный кошелек. Контракт предназначен для валидаторов TON, которые имеют достаточную долю для самоутверждения самостоятельно, не полагаясь на ставки сторонних кандидатов. Контракт представляет собой альтернативную упрощенную реализацию [Nominator Pool](/v3/documentation/smart-contracts/contracts-specs/nominator-pool) интеллектуального контракта, поддерживающего только один знаменатель. Преимущество этой реализации заключается в том, что она более безопасна, так как поверхность атаки значительно меньше. Это связано с массовым снижением сложности пула Nominator, который должен поддерживать нескольких сторонних кандидатов.

## Решение для валидаторов

Этот смарт-контракт предназначен для перехода к решению для валидаторов TON, которые имеют достаточно долей для самостоятельной проверки. Другими имеющимися альтернативами являются:

- использование [горячего кошелька](https://github.com/ton-blockchain/ton/blob/master/crypto/smartcont/wallet3-code.fc) (небезопасно, так как холодный кошелек необходим для предотвращения кражи, если узел проверки взломан)
- с помощью [restricted-wallet](https://github.com/EmelyanenkoK/nomination-contract/blob/master/restricted-wallet/wallet.fc) (который не поддерживается, и имеет неразрешенные вектора атаки, как атаки на осушение газа)
- используя [Nominator Pool](https://github.com/ton-blockchain/nominator-pool) с max_nominators_count = 1 (необязательно сложный с большей поверхностью атаки)

См. более подробное [сравнение существующих альтернатив](#comparison-of-existing-alternatives) ниже.

## Официальный хэш кода

Проверьте это в https://verifier.ton.org перед отправкой средств на живой контракт

```
pCrmnqx2/+DkUtPU8T04ehTkbAGlqtul/B2JPmxx9bo=
```

## Архитектура

Архитектура почти идентична [Nominator Pool](https://github.com/ton-blockchain/nominator-pool) контракту:

![image](/img/nominator-pool/single-nominator-architecture.png)

### Разделение на две роли

- _Владелец_ - "холодный кошелек" (закрытый ключ, не подключенный к Интернету), который владеет средствами, используемыми для разбивки и выступает в качестве одного номинатора
- _Валидатор_ - кошелек, приватный ключ которого находится на узле валидатора (может подписать блоки, но не может украсть использованные средства для ставки)

### Рабочий процесс

1. _Владелец_ удерживает средства для размещения (\$$) в защищенном "холодном кошельке"
2. _Владелец_ вкладывает средства (\$$$) в контракт _СинглНоминатор_ (этот контракт)
3. _MyTonCtrl_ запускается на узле валидатора, подключенном к Интернету
4. _MyTonCtrl_ использует _Validator_ кошелек для инструкции _SingleNominator_, чтобы войти в следующий избирательный цикл
5. _Синглнознаменатель_ посылает долей (\$$$) на _электор_ за один цикл
6. Цикл выборов завершён и ставка может быть восстановлена
7. _MyTonCtrl_ использует кошелек _Validator_ для инструкций _SingleNominator_, чтобы восстановить долю с избирательного цикла
8. _Синглнознаменатель_ возвращает долю предыдущего цикла (\$$) от _электор_
9. Шаги 4-8 повторяются до тех пор, пока _Владелец_ рад продолжать проверку
10. _Владелец_ снимает средства (\$$$) с контракта _СинглНоминатор_ и возвращает их домой

## Вектора Смягчения Атаки

- Узел валидатора требует горячий кошелек для подписания новых блоков. Этот кошелёк по своей сути небезопасен, так как его закрытый ключ подключен к Интернету. Даже если этот ключ скомпрометирован, _Валидатор_ не может извлечь средства, используемые для проверки. Только _Владелец_ может снять эти средства.

- Даже если _Валидатор_ кошелек скомпрометирован, _Владелец_ может указать _СинглНоминатор_, чтобы изменить адрес валидатора. Это помешает атакующему дальше взаимодействовать с _СинглНминатором_. _Владелец_ здесь не будет никаких гоночных условий.

- Баланс _Единый номенклатор_ держит только основные сборные средства - его баланс не используется для оплаты газовых сборов. Газовые деньги для входа в избирательные циклы проводятся в _Валидатор_ кошельке. Это мешает нападающему, который скомпрометировал валидатор от истощения основного ресурса через атаку на газ.

- _СинглНзнаменатель_ проверяет формат всех операций, заданных _Валидатором_, чтобы убедиться, что они не пересылали недопустимые сообщения _электора_.

- В чрезвычайных ситуациях, например, если контракт _электора_ был модернизирован и меняет его интерфейс, _Владелец_ все еще может отправить любое сообщение как _СинглНзнаменатель_, чтобы получить долей _электора_.

- При экстремальной ситуации _Владелец_ может установить код _СинглНоминатора_ и переопределить его текущую логику на случай непредвиденных обстоятельств.

Некоторые из векторов атаки нельзя смягчить с помощью обычного [Nominator Pool](https://github. контракт om/ton-blockchain/nominator-pool) по той причине, что это позволит лицу, управляющему валидатором, украсть средства у его кандидатов. Это не проблема с _СинглНоминатором_, потому что _Владелец_ и _Валидатор_ принадлежат той же стороне.

### Проверки безопасности

Полная проверка безопасности, проведенная Certik и доступная в этом репозитория - [Certik Audit](https://github.com/orbs-network/single-nominator/blob/main/certik-audit.pdf).

## Сравнение существующих альтернатив

Если предположить, что вы являетесь валидатором, который достаточно интересен для самостоятельной проверки, то это альтернативные установки, которые вы можете использовать в MyTonCtrl:

---

### 1. Простой горячий кошелек

Это самая простая настройка, при которой MyTonCtrl подключен к тому же [стандартному кошельку](https://github.com/ton-blockchain/ton/blob/master/crypto/smartcont/wallet3-code.fc), который хранит средства. Поскольку этот кошелёк подключен к Интернету, он считается горячим кошельком.

![image](/img/nominator-pool/hot-wallet.png)

Это небезопасно, так как злоумышленник может получить закрытый ключ при подключении к Интернету. С закрытым ключом злоумышленник может отправить отрядные средства кому-либо в случае блокировки.

---

### 2. Ограниченный кошелек

Эта настройка заменяет стандартный кошелек на [restricted-wallet](https://github.com/EmelyanenkoK/nomination-contract/blob/master/restricted-wallet/wallet. в) которая позволяет отправлять исходящие транзакции только в ограниченные места назначения, такие как _Избиратель_ и адрес владельца.

![image](/img/nominator-pool/restricted-wallet.png)

Ограниченный кошелек не поддерживается (заменяется номинатором-пулом) и имеет нерешенные атак векторы, такие как атаки на газ дренаж. Поскольку один и тот же кошелек удерживает как газовые сборы, так и основную долю на одном балансе, злоумышленник, который ставит под угрозу закрытый ключ, может генерировать транзакции, которые повлекут значительные убытки. Кроме того, существует состояние гонки между нападающим и владельцем при попытке вывода из-за столкновений seqno.

---

### 3. Пул номинирования

The [nominator-pool](https://github.com/ton-blockchain/nominator-pool) was the first to introduce clear separation between the owners of the stake (nominators) and the validator that is connected to the Internet. Эта настройка поддерживает до 40 номинаторов, поставляемых вместе на один и тот же валидатор.

![image](/img/nominator-pool/nominator-pool.png)

Номинальный контракт в пуле излишне сложен благодаря поддержке 40 параллельных номиналов. Кроме того, контракт должен обеспечить защиту кандидатур от развертывания по контракту, поскольку они являются отдельными подразделениями. Эта настройка считается нормальной, но проверка в полной мере затруднена из-за размера атаки. Решение имеет смысл, в основном, если валидатор не имеет достаточно долей для самостоятельной проверки или хочет сделать rev-share с сторонними заинтересованными сторонами.

---

### 4. Одиночный нотариус

Это настройка, реализованная в этом репозитории. Это очень упрощенная версия пула кандидатов, которая поддерживает одного кандидата и не нуждается в защите этого кандидата от развертывания по контрактам, так как они являются одинаковыми структурами.

![image](/img/nominator-pool/single-nominator-architecture.png)

Если у вас есть один номинатор, который отвечает всем требованиям для проверки, это наиболее безопасная настройка, которую вы можете использовать. Поверх простоты, Этот контракт предоставляет владельцу несколько аварийных гарантий, которые могут восстановить долей даже в экстремальных сценариях, таких как _Электрон_ улучшения, которые нарушают интерфейс.

### Только сообщения владельца

Владелец номинатора может выполнить 4 операции:

#### 1. `снимать`

Используется для вывода средств на кошелек владельца. Для вывода средств владелец должен отправить сообщение с телом, включающим в себя: opcode=0x1000 (32 бит), query_id (64 бит) и вывод суммы (хранится как переменная монеты). Контракт на нотариальное назначение будет отправлять средства с флагом BOUNCEABLE и mode=64. <br/><br/>
Если владелец использует **горячий кошелек** (не рекомендуется), [withdraw-deeplink.ts](https://github. om/orbs-network/single-nominator/blob/main/scripts/ts/withdraw-deeplink.ts) может быть использована для создания более глубокой привязки к началу вывода с кошелька tonkeeper. <br/>
Командная строка: `ts-node scripts/ts/withdraw-deeplink.ts single-nominator-addr withdraw-amount` где:

- одноименным кандидатом является адрес одного кандидата, с которого владелец желает снять.
- Сумма снятия – это сумма, которую необходимо снять. Контракт номинала оставит 1 TON в контракте, так что фактическая сумма, которая будет отправлена на адрес владельца, будет минимальной между требуемой суммой и остатком контракта - 1. <br/>
  Владелец должен запустить глубину с телефона с кошельком tonkeeper. <br/>

В случае если владелец использует **холодный кошелек** (рекомендуется), [withdraw.fif](https://github.com/orbs-network/single-nominator/blob/main/scripts/fift/withdraw. можно использовать для создания блока, включающего снятие опкода и снятие суммы. <br/>
Командная строка: `fift -s scripts/fif/withdraw.fif withdraw-amount` где снятие суммы является суммой для снятия с номинального контракта на кошелек владельца. Как описано выше, контракт на номинацию оставит не менее 1 TON в контракте. <br/>
Этот скрипт создаст тело boc (называемое withdraw.boc), которое должно быть подписано и отправлено с кошелька владельца. <br/>
с чёрного компьютера должен запускать владелец:

- создать и подписать tx: `fift -s wallet-v3.fif my-бумажник single_nominator_address sub_wallet_id seqno amount -B withdraw.boc` где my-кошелек является файлом pk владельца (без расширения). Сумма 1 TON должна быть достаточной для оплаты сборов (оставшаяся сумма будет возвращена владельцу). The withdraw.boc is the boc generated above.
- на компьютере с доступом к интернету: `lite-client -C global.config. son -c 'sendfile wallet-query.boc'` отправить файл boc (wallet-query.boc), сгенерированный на предыдущем шаге.

#### 2. `change-validator`

Используется для изменения адреса валидатора. Валидатор может отправлять только NEW_STAKE и RECOVER_STAKE избирателю. Если закрытый ключ валидатора был скомпрометирован, адрес валидатора может быть изменен. Notice that in this case the funds are safe as only the owner can withdraw the funds.<br/>

В случае, если владелец использует **горячий кошелек** (не рекомендуется), [change-validator-deeplink.ts](https://github.com/orbs-network/single-nominator/blob/main/scripts/ts/change-validator-deeplink.ts) может быть использован для генерации более глубокой ссылки на изменение адреса валидатора. <br/>
Командная строка: `ts-node scripts/ts/change-validator-deeplink.ts single-nominator-addr new-validator-address` где:

- однозначный номинатор-addr является адресом однозначного номинатора.
- new-validator-address (по умолчанию ZERO адрес) является адресом нового валидатора. Если вы хотите немедленно отключить валидатор и только позже установить новый валидатор, то удобно установить адрес валидатора на ZERO адрес.
  Владелец должен запустить глубину с телефона с кошельком tonkeeper. <br/>

В случае если владелец использует **холодный кошелек** (рекомендуется), [change-validator.fif](https://github.com/orbs-network/single-nominator/blob/main/scripts/fift/change-validator.) может быть использовано для создания тела, включающего в себя опкод проверки изменений и новый адрес проверки. <br/>
Командная строка: `fift -s scripts/fif/change-validator.fif new-validator-address`.
Этот скрипт создаст boc тело (называемое change-validator.boc), которое должно быть подписано и отправлено с кошелька владельца. <br/>
с чёрного компьютера должен запускать владелец:

- создать и подписать tx: `fift -s wallet-v3.fif my-wallet single_nominator_address sub_wallet_id seqno amount -B change-validator.boc` где my-кошелек является файлом pk владельца (без расширения). Сумма 1 TON должна быть достаточной для оплаты сборов (оставшаяся сумма будет возвращена владельцу). change-validator.boc - это boc созданный выше.
- на компьютере с доступом к интернету: `lite-client -C global.config. son -c 'sendfile wallet-query.boc'` отправить файл boc (wallet-query.boc), сгенерированный на предыдущем шаге.

#### 3. `send-raw-msg`

Это опкод не должен использоваться при нормальных условиях. <br/>
Он может быть использован для отправки **любого** сообщения из контракта на нотариуса (должен быть подписан и отправлен из кошелька владельца). <br/>
Вы можете использовать этот opcode если, например, адрес контракта избирателей был неожиданно изменен, и средства по-прежнему заблокированы на выборах. В этом случае RECOVER_STAKE от валидатора не будет работать, и владелец должен будет построить конкретное сообщение. <br/>
Тело сообщения должно включать: opcode=0x7702 (32 бит), query_id (64 бит), режим (8 бит), ссылка на msg ячейки, которая будет отправлена в виде сырого сообщения. <br/>

#### 4. `улучшение`

This is an emergency opcode and probably should never not be used.<br/>
It can be used to upgrade the nominator contract. <br/>
Тело сообщения должно включать: opcode=0x9903 (32 бит), query_id (64 бит), ссылку на новый код ячейки. <br/>

## Смотреть также

- [Один знаменательный контракт](https://github.com/orbs-network/single-nominator)
- [Как использовать Единый Номинатор Пула](/v3/guidelines/smart-contracts/howto/single-nominator-pool)
