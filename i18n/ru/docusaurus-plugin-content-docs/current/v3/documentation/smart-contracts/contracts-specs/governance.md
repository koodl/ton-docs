# Управляющие контракты

В TON, консенсусные параметры работы узлов, относящиеся к TVM, catchain, комиссии, и топология цепи (а также то, как эти параметры хранятся и обновляются) контролируются набором специальных смарт-контрактов (в отличие от устаревших и негибких способов программирования тех параметров, которые применяются блокчейнами предыдущих поколений). Таким образом, TON осуществляет комплексное и транспарентное управление в рамках цепи. Комплекс специальных договоров сам регулируется параметрами и в настоящее время включает в себя электродвигателя, Конфигурация и DNS контрактов и в будущем будут расширены вневалютными Minter и другими.

## Электрик

Умный контракт электродвигателя управляет тем, как раунды проверки изменяют друг друга, кто получает обязанность проверить блокчейн и как будут распределяться вознаграждения за валидацию. Если вы хотите стать валидатором и взаимодействовать с Elector, обратитесь к [инструкциям по валидации](https://ton.org/validator).

Elector хранит данные Toncoin, которые не выводятся в хэшкарте `credits`, новые приложения в хэшкарте `elect`, и информацию о предыдущих выборах в _past\_elections_ хэшмэне (последний хранится внутри _жалобы_ о неправильном поведении валидатора и _frozen_-ставках валидатора для уже завершенных раундов, которые не соответствуют `stake_held_for`(ConfigParam 15)). Контракт на электродвигатель преследует три цели:

- Обработка заявок для выбора валидаторов
- Задерживать выборы
- Проверка процесса невыполнения отчетов
- Распространять награды проверки

### Обработка приложений

Для создания приложения будущий валидатор должен сформировать специальное сообщение, содержащее соответствующие параметры (ADNL адрес, открытый ключ, `max_factor` и т.д. , приложите его к некоторой сумме TON (называемой досье), и отправьте его электору. В свою очередь, Избиратель проверяет эти параметры и либо регистрирует приложение, либо немедленно возвращает долю обратно отправителю. Обратите внимание, что приложения принимаются только с адресов в мастер-цепочке.

### Проведение выборов

Избиратель является специальным смарт-контрактом, который имеет возможность принудительно вызвать в начале и конце каждого блока (так называемые тиковые и Tock транзакции). Избиратель действительно ссылается на каждый блок и проверяет, пришло ли время для проведения новых выборов.

Общая концепция избирательного процесса заключается в рассмотрении всех приложений, в частности, их количество TON и `max_factor` (максимальное соотношение результатов проверки, которое кандидат согласился сделать по сравнению с самым слабым валидатором), и задать вес для каждого валидатора пропорционально количеству TON, но таким образом, что выполняются все условия `max_factor`.

Технически она реализуется следующим образом:

1. Elector принимает все приложения с суммой выше текущего минимума сети `min_stake` (ConfigParam 17).
2. Он сортирует их по категориям в порядке убывания.
3. Если больше участников больше, чем максимальное число валидаторов (`max_validators` ConfigParam 16), сбросить хвост списка.
4. Цикл «i» от «1» до «N» (оставшееся количество участников).

- Снять первый элемент `i` из списка (сортируется по убыванию)
- Предположим, что кандидат _i_-th будет последним принятым (и таким образом имеет наименьший вес) и рассчитывает эффективную долю (`true_stake` в коде) по отношению к `max_factor`. Другими словами, действительная доля кандидата в _j_-м (`j<i`) рассчитывается как `min(цена[i]*max_factor[j], ставка[j])`.
- Расчет общей ставки (ТЕС) участников от 1 до _i_th. Если это TES выше, чем предыдущий максимальный TES, подумайте о текущей конфигурации наибольшего веса.

5. Получить лучшую текущую конфигурацию, т.е. конфигурация веса, использующая максимальную ставку, и отправить его в конфигурационный контракт (Конфигурационный контракт, см. ниже), чтобы стать новым набором валидаторов.
6. Разместите все неиспользуемые ставки, такие как те, которые не становятся валидаторами и превосходящими (если таковые имеются) `ставки[j]-min(доля[i]*max_factor[j], поставите[j])` в `credits` таблицу из которой они могут быть запрошены кандидатами.

Таким образом, если у нас девять кандидатов на 100 000 человек и в 2,7 раза на одного участника с 10 000. Последний участник не будет избран: без него эффективным было бы 900, 00, и с ним всего 9 \* 27,000 + 10,000 = 253 000. Напротив, если у нас есть один кандидат на 100 000 человек, а число - 2,7 и 9 участников на 10 000, то все они становятся валидаторами. Тем не менее, первый кандидат поставит только 10\*2.7 = 27 000 TON, при этом свыше 73 000 TON вписывается в `credits`.

Имейте в виду, что существуют некоторые ограничения (очевидно контролируемые параметрами конфигурации TON) на результирующем наборе валидации, в частности, `min_validators`, `max_validators` (ConfigParam 16), `min_stake`, `max_stake`, `min_total_stake`, `max_stake_factor` (ConfigParam 17). Если не будет возможности удовлетворить эти условия с учетом нынешних заявлений, выборы будут отложены.

### Процесс некорректности проверки отчетов

Каждый валидатор время от времени назначается случайным образом для создания нового блока (если валидатор проваливается через несколько секунд, Эта обязанность передается следующему валидатору). Частота таких назначений определяется весом валидатора. Таким образом, каждый может получить блоки из предыдущего раунда проверки и проверить, близко ли ожидаемое количество генерируемых блоков к реальному количеству блоков. Статистически значимое отклонение (когда количество генерируемых блоков меньше, чем ожидалось) означает, что валидатор неправильно выполняется. В ТОН относительно легко доказать неправомерное поведение с помощью доказательств Merkle. Контракт избирателя принимает такое доказательство с предложенным штрафом от всех, кто готов оплатить его хранение и регистрирует жалобу. Затем каждый валидатор текущего раунда проверяет жалобу, и если это правильно, и предлагаемый штраф соответствует серьезности неправильного поведения, они голосуют за него. После получения более 2/3 голосов по весу, жалоба принимается, и штраф удаляется из хэшкарты `frozen` соответствующего элемента `past_elections`.

### Распределение вознаграждений за подтверждение

Точно так же, как с проверкой, пришло ли время провести новые выборы, Электрик в каждом блоке проверяет, пришло ли время выпустить средства из «замороженных» для хранимых «past_elections». На соответствующем блоке, Избиратель распределяет накопленные доходы из соответствующих раундов проверки (платы за газ и вознаграждения за создание блоков) проверяющим участникам этого окружения пропорционально весу валидатора. После этого ставки с наградами добавляются в таблицу `credits`, а выборы удаляются из таблицы `past_elections`.

### Текущее состояние электората

You can check current state in the [dapp](https://1ixi1.github.io/elector/), which allows to see elections participants, locked stakes, ready to withdraw funds, complaints and so on.

## Настройка

Настройка смарт-контракта управления параметрами конфигурации TON. Его логика определяет, кто и при каких условиях имеет право изменять некоторые из этих параметров. Она также внедряет механизм голосования/механизма проверки и устанавливает обновления для проверки достоверности.

### Валидатор устанавливает обновления ротации

Как только конфигурационный контракт получает специальное сообщение от электродвигателя контракта, который уведомляет его о выбранном новом наборе валидаторов, Конфигурация добавляет новый валидатор в ConfigParam 36 (следующие валидаторы). Затем, во время транзакций TickTock в каждом блоке, Конфигурация проверяет, пришло ли время применить новый набор валидатора (время `utime_since` встроено в сам набор валидатора) и перемещает предыдущий набор из ConfigParam 34 (текущие валидаторы) в ConfigParam32 (предыдущие валидаторы) и устанавливает из ConfigParam 36 в ConfigParam 34.

### Механизм предложения/голосования

Тот, кто готов оплатить плату за хранение предложения, может предложить изменить один или несколько параметров конфигурации, отправив соответствующие сообщения в Конфигентный контракт. В свою очередь, любой валидатор в текущем наборе может проголосовать за это предложение, подписав сообщение об утверждении с его приватным ключом (обратите внимание, что соответствующий открытый ключ хранится в ConfigParam 34). Получив или не получив 3/4 голосов (с учетом веса держателей), предложение выигрывает или проигрывает раунд. При выигрыше критического числа раундов (`min_wins` ConfigParam 11), предложение принимается; при потере критического количества раундов (`max_losses` ConfigParam 11), он будет снят.
Обратите внимание, что некоторые параметры считаются критическими (набор критических параметров сам по себе является параметром конфигурации ConfigParam 10) и Таким образом, требуется принятие большего количества раундов.

Индексы параметров конфигурации `-999`, `-1000`, `-1001` зарезервированы для голосования за механизм аварийного обновления и обновления кода конфигурации и электора. Когда предложение с соответствующими показателями получает достаточное количество голосов в достаточном количестве раундов, соответствующих ключу экстренной помощи, код Конфигурационного контракта или код договора электродвигателя обновится.

#### Экстренное обновление

Валидаторы могут голосовать за присвоение специального открытого ключа для обновления параметров конфигурации, когда это невозможно с помощью механизма голосования. Это временная мера, необходимая для активного развития сети. Ожидается, что по мере развития сети эта мера будет постепенно прекращена. Как только он будет разработан и протестирован, ключ будет передан в мультиподпись. И как только сеть доказала свою стабильность, аварийный механизм будет полностью отключен.

Валидаторы действительно проголосовали за присвоение этого ключа Фонду TON в июле 2021 года (блок masterchain `12958364`). Заметим, что такой ключ может быть использован только для ускорения обновления конфигурации. Он не может вмешиваться в код, хранение и баланс любого контракта ни по одной цепочке.

История аварийных обновлений:

- 17 апреля 2022 года, количество заявлений на выборы увеличилось достаточно большое, что выборы не могли быть проведены в газовые ограничения на тот момент. В частности, выборы требовали более 10 миллионов газов, а блок `soft_limit` и `hard_limit` был установлен в `10m` и `20m` (ConfigParam 22), `special_gas_limit` и `block_gas_limit` были установлены в `10m` и `10m`, соответственно, (ConfigParam 20). Таким образом, новые валидаторы не могут быть установлены и из-за достижения предела газа-блока, транзакции, которые обрабатывают внутренние сообщения на masterchain не могут быть включены в блок. В свою очередь, что приводит к неспособности голосовать за обновления конфигурации (невозможно выиграть требуемое количество раундов, так как текущий раунд не смог завершить). Экстренный ключ был использован для обновления ConfigParam 22 `soft_limit` до 22 м и `hard_limit` до 25 м (в блоке `19880281`) и ConfigParam 20 `special_gas_limit` до 20 м и `block_gas_limit` до 22 м (в блоке `19880300`). В результате этого выборы были успешно проведены, следующий блок потреблял газ `10 001 444`. Общая перенос выборов на более поздний срок составляла около 6 часов, и не сказалась на функциональности базовой цепочки.
- 2 марта 2023 года количество заявлений на выборы увеличилось достаточно большое, что даже `20m` было недостаточно для проведения выборов. Тем не менее, в этот раз masterchain продолжает обрабатывать внешние сообщения из-за большей `hard_limit`. Ключ аварийной ситуации был использован для обновления ConfigParam 20 `special_gas_limit` до 25 м и `block_gas_limit` до 27 м (в блоке `27747086`). В результате выборы были успешно проведены в следующем блоке. Не было сказано о том, что общее время проведения выборов было отсрочено до 6 часов, помимо выборов, функциональность как главной цепочки, так и базовой цепочки.
- 22 ноября 2023 года ключ был использован в [отказе от себя](https://t.me/tonblockchain/221) (в блоке `34312810`). В результате, публичный ключ был заменен на 32 нулевых байта.
- Из-за переключения на реализацию OpenSSL проверки подписи Ed25519, проверьте [все символы публичного ключа одинаковые](https://github.com/ton-blockchain/ton/blob/7fcf26771748338038aec4e9ec543dc69afeb1fa/crypto/ellcurve/Ed25519.cpp#L57C1-L57C1) был отключен. В результате сверьте с нулевым публичным ключом перестала работать, как это было запланировано. С помощью этой проблемы ключ экстренной ситуации [был обновлен 9 декабря](https://t.me/tonstatus/80) еще раз (в блоке `34665437`, [tx](https://tonscan. rg/tx/MU%2FNmSFkC0pJiCi730Fmt6PszBooRZkzgiQMv0sExfY=)) to noth-in-my-sleeve byte-sequence `82b17caadb303d53c3286c06a6e1affc517d1bc1d3ef2e4489d18b873f5d7cd1`, это `sha256("Некорректная точка кривы")`. Теперь единственный способ обновить сетевые параметры - это достичь консенсуса валидатора.

## Смотреть также

- [Прекомпилированные контракты](/v3/documentation/smart-contracts/contracts-specs/precompiled-contracts)
