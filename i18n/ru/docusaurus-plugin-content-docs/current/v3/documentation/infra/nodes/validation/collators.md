# Разделение валидатора/оллятора

:::caution в разработке
Эта функция testnet только сейчас! Участвуйте на свой страх и риск.
:::

Ключевой особенностью блокчейна TON является способность распространять обработку транзакций по сетевым узлам, и переход с "все проверяют все транзакции" на "каждая транзакция проверяется с помощью надежного подмножества валидатора". Эта возможность бесконечно горизонтально масштабируется сквозь шарды, когда одна рабочая цепочка делится на требуемое количество _шардчейнов_ отличает TON от других сетей L1.

Однако необходимо регулярно вращать поднаборы валидатора, которые обрабатывают один или другой шард для предотвращения сговора. В то же время для обработки транзакций валидаторам явно необходимо знать состояние предыдущего шарда транзакции. Самый простой подход заключается в том, чтобы требовать от всех валидаторов знать состояние всех шардов.

Такой подход хорошо работает, в то время как число пользователей TON находится в пределах нескольких миллионов и TPS (транзакций в секунду) составляет менее 100. Однако, в будущем, когда TON будет обрабатывать много тысяч транзакций в секунду и сервер сотни миллионов или миллиарды людей, ни один сервер не сможет сохранить фактическое состояние всей сети. К счастью, TON был разработан с учетом таких нагрузок и поддерживает как загрузку, так и обновление состояния.

Это достигается за счет разделения двух ролей:

- _Коллектор_ - персонаж, который отслеживает только часть сети, знает фактическое состояние и _коллат_ (генерирует) следующие блоки
- _Validator_ - персонаж, который получает новые блоки от _Collator_, проверяет их правильность и подписывает это эффективно гарантируя правильность на риск потери ставки.

В то же время архитектура TON позволяет _Validator_ эффективно проверять новые блоки без сохранения состояния блокчейна, проверяя специально созданные доказательства.

Таким образом, при прохождении TON будет тяжело обрабатываться одной машиной, сеть будет состоять из подсети, каждая из которых будет обрабатывать только часть цепочек, которые она может обрабатывать и подсеть валидаторов, которые сформируют множество безопасных наборов для совершения новых транзакций.

В настоящее время тестовая сеть TON используется для тестирования разделения _Валидатор_/_Коллектор_, где работают некоторые валидаторы как обычно, и некоторые валидаторы не объединяют блоки для себя и получают их от коллаторов.

# Присоединиться к "lite validator"

Новое программное обеспечение узла доступно в ветке [accelerator](https://github.com/ton-blockchain/ton/tree/accelerator).

## Коллатор

Для создания нового коллажа необходимо настроить TON узел; вы можете использовать флаг `-M`, чтобы заставить узел не держать след за шардчейнами, он не обрабатывается.

В `validator-engine-console` создайте новый ключ для коллажа, установите этот ключ в категорию adnl `0` и добавьте элемент коллажа через команду:

```bash
addcollator <adnl-id> <chain-id> <shard-id>
```

Например:

```bash
newkey
addadnl <adnl-id> 0
addcollator <adnl-id> 0 -9223372036854775808
```

Коллектор, который настроен на шард wc:shard_pfx может обобщать блоки в осколках wc:shard_pfx, его предки и его потомки; он также будет контролировать все шире осколков, потому что это требуется для сопоставления.

Колятор может быть остановлен командой:

```bash
delcollator <adnl-id> 0 -9223372036854775808
```

:::info
В настоящее время в сети есть один столбик, а конфигурация **-41** используется для объявления адреса adnl.
:::

## Validator

Для запуска валидатора необходимо настроить TON узел, используйте флаг `--lite-validator` чтобы заставить валидатор запрашивать новые блоки от коллажей вместо того, чтобы генерировать их, и настроить процесс разбиения. Валидатор в режиме Liite принимает узлы коллактора из конфигурации `-41`.

Самый простой способ заключается в следующем:

- установка MyTonCtrl для testnet
- Stop validator `sudo systemctl stop validator`
- Обновить файл сервиса `sudo nano /etc/systemd/system/validator.service`: добавить флаг `--lite-validator`
- Перезагрузить systemctl `sudo systemctl daemon-reload`
- Запустить валидатор `sudo systemctl start validator`

## Liteserver

Подобно Collators, Liteservers можно настроить только для отслеживания некоторых частей blockchain. Это можно сделать, запустив узел с параметром `-M` и добавив шарды в `validator-engine-console`:

```bash
addshard 0 -9223372036854775808
```

Шедевральная цепь всегда контролируется по умолчанию. Осколки можно удалить с помощью `delshard 0 -9223372036854775808`.

### Lite клиент

Глобальная конфигурация должна содержать хотя бы одну из двух секций: `liteservers` и `liteservers_v2`. Первый раздел содержит "полные" Liteserver, у которых есть данные обо всех государствах шарда. Второй раздел содержит "частичные" Liteserver, содержащие данные о части блокчейна.

"Частичные" Liteservers описаны следующим образом:

```json
"liteservers_v2": [
  {
    "ip": ...,
    "port": ...
    "id": {
      "@type": "pub. d25519",
      "ключ": "...
    },  
    "шарды": [
      {   
        "workchain": 0, 
        "Шард": -9223372036854775808
      }   
    ]   
  }
  . .
]
```

Lite Client и Tonlib поддерживают эту конфигурацию и могут выбрать подходящий Liteserver для каждого запроса. Обратите внимание, что каждый сервер Liteserver контролирует masterchain по умолчанию, и каждый сервер в `liteservers_v2` явно настроен на принятие запросов о masterchain. Шар `wc:shard_pfx` в конфигурации означает, что сервер принимает запросы о шарде `wc:shard_pfx`, его предки и его потомки (так же, как и конфигурация коллаторов).

## Полные сопоставленные данные

По умолчанию валидаторы, предлагающие новый блок в наборе валидаторов, не прикрепляют данные, которые подтверждают состояние "до блока". Эти данные должны быть получены другими валидаторами из локального состояния. Таким образом, старые (из главной ветви) и новые узлы могут достичь консенсуса, но новые валидаторы должны следить за всем состоянием сети.

Обновление до нового протокола, когда валидаторы будут делиться блоками с сопоставленными данными, может быть сделано с помощью

- Обновление всех валидаторов до новой версии узла
- Установка [full_collated_data](https://github.com/ton-blockchain/ton/tree/accelerator/crypto/block/block.tlb#L858) на true

# Следующие шаги

Практическая способность разделять роли _валидатора_ и _коллатора_ является главной вехой на пути к бесконечной пропускной способности, но для создания действительно децентрализованной и устойчивой к цензуре сети необходимо

- обеспечить независимость и избыточность _коллакторов_
- обеспечить стабильный и безопасный способ взаимодействия валидаторов и Collators
- обеспечить подходящую финансовую модель для коллаторов, которые стимулируют прочное сопоставление новых блоков

В настоящее время эти задачи не охвачены.
