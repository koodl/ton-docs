# Доп. валюта добычи

## Извлечение

Согласно [Белой бумаге Ton Blockchain 3.1.6](https://ton-blockchain.github.io/docs/tblkch. df#page=55), TON Blockchain позволяет своим пользователям определять произвольные криптовалюты или токены отдельно от Toncoin, при условии соблюдения некоторых условий. Такие дополнительные криптовалюты идентифицируются по _currency\_ids_. The list of defined additional cryptocurrencies is a part of the blockchain configuration,
stored in the masterchain. Каждое внутреннее сообщение, а также остаток на счете содержат специальное поле для "ExtraCurrencyCollection" (набор извлечений, прикрепленных к сообщению или сохраненных на балансе):

```tlb
extra_currencies$_ dict:(HashmapE 32 (VarUInteger 32)) = ExtraCurrencyCollection;
валюты$_ граммы:Grams other:ExtraCurrencyCollection = ВалютКоллекция;
```

## Настройка извлечения

Словарь «ExtraCurrencyCollection» всех валют, которые должны быть добыты, хранится в `ConfigParam7`:

```tlb
_ to_mint:ExtraCurrencyCollection = ConfigParam 7;
```

`ConfigParam 6` содержит данные, касающиеся майнинга:

```tlb
_ mint_new_price:Grams mint_add_price:Grams = ConfigParam 6;
```

`ConfigParam2` содержит адрес _Minter_.

## Поток горняков низкого уровня

В каждом блоке коллаж сравнивает старый глобальный баланс (глобальный баланс всех валют в конце блока prev) с `ConfigParam7`. Если сумма для любой валюты в `ConfigParam7` меньше, чем в глобальном балансе - конфигурация недействительна. Если какая-либо валюта в `ConfigParam7` выше, чем в глобальном балансе, будет создано minting сообщение.

Это сообщение имеет источник `-1:0000000000000000000000000000000000000000000000000000000000000000000000000000000000` и _Minter_ из `ConfigParam2` как назначения и содержит excesses извлечений в `ConfigParam7` на старом глобальном балансе.

Проблема здесь заключается в том, что горняковое сообщение содержит только дополнительные валюты и нет монет TON. Это означает, что даже если _Minter_ установлен как фундаментальный смарт-контракт (представлен в `ConfigParam31`), сообщение может привести к прерванной транзакции: `compute_ph:(tr_phase_compute_skip_no_gas)`.

## Высокоуровневый горный поток

_Minter_ смарт-контракт при получении запроса на создание новых извлечений или майнинг дополнительных токенов для существующих контрактов должны:

1. Проверьте, что комиссия, определенная в 'ConfigParam6', может быть снята из сообщения запроса
2. 1. для существующих токенов: проверьте авторизацию для майнинга (только _владелец_ может занимать новые)
   2. для создания новых валют: проверьте, что идентификатор криптовалюты не занят и хранит владельца новой валюты
3. отправить сообщение в конфигурационный контракт (такое сообщение должно привести к добавлению в `ExtraCurrencyCollection` в `ConfigParam7`)
4. отправьте сообщение на `0:0000...0000` (которое гарантированно отскакивается в следующих или следующих блоках) с идентификатором extra_currency

По получении сообщения от `0:0000...0000`

1. читать extra_currency id из сообщения о возврате
2. если есть токены с соответствующим идентификатором на minter балансе отправьте их владельцу этой валюты с сообщением `ok`
3. иначе отправить владельцу валюты сообщение `fail`

## Замечания, подлежащие разрешению

1. Обсуждение с отправкой сообщения на `0:0000...0000` для отсрочки обработки запроса довольно грязное.
2. Случаи, когда майнинг не удался, должны быть продуманы. На данный момент это выглядит как единственная возможная ситуация, когда сумма валюты равна 0 или такой, что текущий баланс плюс minted сумма не вписывается в `(VarUInteger 32)`
3. Как сжечь? На первый взгляд нет ни одного пути.
4. Должны ли гонорары быть запрещенными? Другими словами, опасно ли иметь миллионы извлечений (большой конфигурации, потенциальный DoS из-за несвязанного количества операций выкупа при столкновении?)
